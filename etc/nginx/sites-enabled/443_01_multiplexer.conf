stream {
    map $ssl_preread_server_name $tls_port {
        hostnames;
        github.com      9443; # Xray
        default         8443; # MTProxy
    }

    map $ssl_preread_protocol $upstream_selector {
        ""        127.0.0.1:22;        # SSH
        default   127.0.0.1:$tls_port; # TLS â†’ SNI
    }

    server {
        listen 443;
        proxy_pass $upstream_selector;
        ssl_preread on;
    }
}
