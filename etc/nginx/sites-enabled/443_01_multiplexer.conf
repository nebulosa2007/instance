stream {
    map $ssl_preread_server_name $tls_port {
        hostnames;
        icloud.com 6443; # Xray mobile
        *.sslip.io 9443; # Xray desktop
        mt.*       8443; # MTProxy fast
        default    8443; # MTProxy reserve
    }

    map $ssl_preread_protocol $upstream_selector {
        ""        127.0.0.1:22;        # SSH
        default   127.0.0.1:$tls_port; # TLS → дальше через map
    }

    server {
        listen 443;
        proxy_pass $upstream_selector;
        ssl_preread on;

        proxy_connect_timeout 1s;
        proxy_timeout 1h;

        error_log  /var/log/nginx/stream_error.log warn;
    }
}
