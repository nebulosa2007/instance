# Block large requests
client_max_body_size 10M;

# Hide nginx version
server_tokens off;

set $block_ua 0;

# Block malicious or empty User-Agents
if ($bad_user_agent = 1) {
    set $block_ua 1;
}

if ($bad_user_agent = 3) {
    set $block_ua 1;
}

# Allow robots.txt only for AI Bots
if ($request_uri = "/robots.txt") {
    set $is_for_bots 1;
}

if ($bad_user_agent = 3) {
    set $ai_on_robots "${is_for_bots}";
}

if ($ai_on_robots = 1) {
    set $block_ua 0;
}

# Block all other requests
if ($block_ua = 1) {
    return 444;
}

# Block all without encoding except some clients
if ($block_no_encoding = 1) {
    return 444;
}

# Block HTTP 1.1 except some clients
if ($block_http1 = 1) {
    return 444;
}

if ($is_bad_ref = 1) {
    return 444;
}

# Block binary data in requests
if ($request_uri ~ [\x00-\x08\x0B-\x0C\x0E-\x1F\x7F]) {
    return 444;
}

# Limit HTTP methods
if ($request_method !~ ^(GET|HEAD|POST)$ ) {
    return 444;
}

location = /robots.txt {
    default_type text/plain;
    return 200 "User-agent: *\nDisallow: /\n";
}

# Protection against path traversal
location ~ /?\.\./ {
    deny all;
    return 444;
}

# Block access to hidden files and configurations
location ~* (/\.(env|git|ht|htaccess|svn)|\.(bak|config|sql|old|save|swp|backup|bkp)$) {
    deny all;
    return 444;
}

# Block access to administrative panels
location ~* ^/(admin|manager|login|config|app|phpunit|vendor|\.git|wp-admin) {
    deny all;
    return 444;
}

# Block CGI exploits
location ~* ^/cgi-bin/ {
    deny all;
    return 444;
}

# Stricter rate limiting for API endpoints
location ~* ^/(api|login|auth) {
    limit_req zone=api burst=10 nodelay;
}
