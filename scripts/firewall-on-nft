#!/bin/bash
# Based on: https://wiki.archlinux.org/title/Nftables#Single_machine

# isRoot
[[ "$EUID" != 0 ]] && {
    echo "You need to run this script as root"
    exit 1
}

# Interactive port selection
[[ "$1" != "off" ]] && {
    for p in tcp udp; do
        echo -e "\nOpen ${p^^} ports by processes:\n"
        ops=$(ss -ln --$p | grep -Ev "(127\.|\[::\])" | grep -Po '(?<=:)(\d+)' | sort -nu | tr '\n' ' ')
        ss -lnp --$p | tail -n +2 | grep -Ev "(127\.|\[::\])" | sed 's/users:(("//g;s/:/ /;s/"/ /' | awk '{print $4, $5, $7}' | (
            echo "Address Port Process"
            sort -nk3,3 -nk2
        ) | column -t -R1
        declare -n ops_ref="ops_$p"
        read -rp $'\nPlease enter the '"${p^^}"$' ports (IPv4 only) for opening outside: ' -e -i "$ops" ops_ref
    done
}

echo " * Flushing all rules"
nft flush ruleset

# Just flush all rules?
[[ "$1" == "off" ]] && {
    echo "[*] Firewall is fully disabled"
    nft list ruleset
    exit 0
}

echo " * Creating main firewall ruleset"

# Detect IPv6 gateway
ipv6gateway=$(ip -6 route | grep -Pom1 '^default via \K\S+')

# Build complete nftables configuration
cat > /etc/nftables.conf <<'NFTEOF'
#!/usr/sbin/nft -f

table inet filter {
    chain TCP {
    }

    chain UDP {
    }

    chain input {
        type filter hook input priority filter; policy drop;

        # Allow established/related connections
        ct state related,established accept

        # Drop packets to address not configured on incoming interface (Strong Host Model)
        fib daddr . iif type != { local, broadcast, multicast } drop

        # Allow loopback
        iif lo accept

        # Drop invalid packets
        ct state invalid drop

        # ICMP (ping responses and essential error messages)
        ip protocol icmp icmp type { echo-reply, destination-unreachable, time-exceeded, parameter-problem } accept
        ip protocol icmp icmp type echo-request limit rate 1/second burst 5 packets ct state new accept

        # IGMP for multicast
        ip protocol igmp accept

        # ICMPv6 (IPv6 neighbor discovery and essential messages)
        ip6 nexthdr icmpv6 icmpv6 type { nd-neighbor-solicit, nd-router-advert, nd-neighbor-advert } ip6 saddr fe80::/10 accept
        ip6 nexthdr icmpv6 icmpv6 type echo-request limit rate 1/second burst 5 packets ct state new accept
        ip6 nexthdr icmpv6 ip6 saddr fe80::/10 accept

        # DHCPv6 client
        udp sport 547 udp dport 546 accept

        # Forward new connections to protocol-specific chains
        meta l4proto udp ct state new jump UDP
        tcp flags syn ct state new jump TCP

        # Reject everything else with appropriate response
        meta l4proto tcp reject with tcp reset
        meta l4proto udp reject with icmpx type port-unreachable
        reject with icmpx type port-unreachable
    }

    chain forward {
        type filter hook forward priority filter; policy drop;

        ct state related,established accept
        jump fw-interfaces
        jump fw-open
        reject with icmpx type host-unreachable
    }

    chain output {
        type filter hook output priority filter; policy accept;
    }

    chain fw-interfaces {
    }

    chain fw-open {
    }
}
NFTEOF

# Add IPv6 raw table for rpfilter if gateway exists
if [ "$ipv6gateway" ]; then
    echo " * IPv6 gateway detected: $ipv6gateway"
    cat >> /etc/nftables.conf <<NFTEOF

table ip6 raw {
    chain prerouting {
        type filter hook prerouting priority raw; policy accept;
        fib saddr . iif oif exists accept
        ip6 saddr ${ipv6gateway}/128 accept
        drop
    }
}
NFTEOF
else
    echo " * No default IPv6 gateway found"
fi

# Add port rules
echo "" >> /etc/nftables.conf
echo "# Custom port rules" >> /etc/nftables.conf

for p in tcp udp; do
    declare -n ops_ref="ops_$p"
    if [[ -n "$ops_ref" ]]; then
        echo " * Adding ${p^^} ports: $ops_ref"
        for op in $ops_ref; do
            if [[ "$p" == "tcp" ]]; then
                echo "add rule inet filter TCP tcp dport $op accept" >> /etc/nftables.conf
            else
                echo "add rule inet filter UDP udp dport $op accept" >> /etc/nftables.conf
            fi
        done
    fi
done

echo " * Loading nftables rules"
nft -f /etc/nftables.conf

echo " * Enabling and starting nftables.service"
systemctl enable --now nftables.service

echo "All set. Good luck!"
echo
echo "Current ruleset:"
nft list ruleset
